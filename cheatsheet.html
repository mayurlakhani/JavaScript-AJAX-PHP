<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>CheatSheet</title>
    <style>
      #main {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #formDiv {
       margin-top: 20px;
      }
      #profile {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
     
    </style>
  </head>
  <body>
    <div id="main">
      <div id="formDiv">
        <form id="myForm" class="needs-validation">
          <div class="form-floating mb-3 mt-3">
            <input type="text" class="form-control" name="fname" id="fname" placeholder="firstname" required><br>
            <label for="fname" class="form-label"> First name</label>
            <span class="invalid-feedback">Please enter a value for fname </span>
            <small></small>
          </div>
          <div class="form-floating mb-3 mt-3">
            <input type="text" class="form-control" name="lname" id="lname" placeholder="lastname" required><br>
            <label for="lname" class="form-label"> Last name </label>
            <span class="invalid-feedback">Please enter a value for lname </span>
          </div>
          <div class="form-floating mb-3 mt-3">
            <input type="email" class="form-control" name="email" id="email" placeholder="email" required><br>
            <label for="email" class="form-label"> Email</label>
            <span class="invalid-feedback">Please enter a value for email </span>
            <small></small>
          </div>
          <div class="form-floating mb-3 mt-3">
            <input type="password" class="form-control" name="password" id="password" placeholder="password" required><br>
            <label for="password" class="form-label"> Password</label>
            <span class="invalid-feedback">Please enter a value for password </span>
            <small></small>
          </div>
          <div class="form-floating mb-3 mt-3">
            <input type="password" class="form-control" name="confirm-password" id="confirm-password" placeholder="refill password" required><br>
            <label for="confirm-password" class="form-label"> confirm Password</label>
            <span class="invalid-feedback">Please refill a value for password </span>
            <small></small>
          </div>
          <div class="mb-3">
            <label for="img-upload" class="form-label">profile photo</label>
            <input class="form-control" type="file" id="formFile" name="image" id="img-upload" accept="image/gif, image/jpeg, image/png" onchange="loadFile(event)" required>
            <span class="invalid-feedback">Please select profile picture</span>
          </div>
          <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBar"></div>             
          </div>
          <div id="profile"></div><br>
          <div class="form-check">
            <h6>Gender:</h6>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" id="gender_male" name="gender" value="male" required>
                <label class="form-check-label" for="gender_male">Male </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" id="gender_female" name="gender" value="female" required>
                <label class="form-check-label" for="gender_female">Female </label>
              </div>
              <div class="invalid-feedback">
                Please select a gender.
              </div>
          </div><br>
          <div class="form-floating">
            <select class="form-select form-floating" id="cars" name="cars" aria-label="Select a car" required>
              <option value="volvo">Volvo XC90</option>
              <option value="saab">Saab 95</option>
              <option value="mercedes" selected="selected">Mercedes SLK</option>
              <option value="audi">Audi TT</option>
            </select>
            <label for="cars">Select a car:</label>
            <div class="invalid-feedback">Please select a car./div>
          </div><br>
        
          <div class="form-check">
              <h6>Select extra service:</h6>
              <div class="form-check">
                <input class="form-check-input services" type="checkbox" name="service[]" value="software" value="" id="software" required>
                <label class="form-check-label" for="software">
                  <span>software Update</span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input services" type="checkbox" name="service[]" value="maintainance" id="maintainance" required>
                <label class="form-check-label" for="maintainance">
                  <span>Maintainance</span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input services" type="checkbox" name="service[]" value="insurance" id="insurance" required>
                <label class="form-check-label" for="insurance">
                  <span>Insurance</span>
                </label>
              </div>
          </div><br>
          <div class="form-floating">
            <textarea class="form-control" placeholder="Leave a comment here" id="suggestion" name="suggestion" rows="4" cols="50"  required></textarea>
            <label for="suggestion">add your suggestion:</label>
            <div class="invalid-feedback">
              Please enter a message in the textarea.
            </div>
          </div><br>
          <div class="form-check">
            <input class="form-check-input services" type="checkbox" id="agree" name="agree" value="agree" required>
            <label class="form-check-label" for="agree">
              <span>I Agree</span>
            </label>
            <div class="invalid-feedback">Please agree conditions</div>
          </div><br>
          <div class="row">
            <div class="col"><input type="submit" value="Submit" class="btn btn-outline-primary"></div>
            <div class="col"><input type="reset" class="btn btn-outline-secondary"></div>
          </div>
        </form> 
      </div>
      show Response:
      <div id="resut"></div>
    
    </div>
      <script>
          
          let form = document.forms["myForm"];
          //===============
          //form validaion
          //===============
          const submitButton = form.querySelector('input[type="submit"]');
          let usernameEl = document.querySelector("#fname");
          let emailEl = document.querySelector("#email");
          let passwordEl = document.querySelector("#password");
          let confirmPasswordEl = document.querySelector("#confirm-password")
          const isEmailValid = (email) => {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
          };
          const isPasswordSecure = (password) => {
            const re = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{8,})");
            return re.test(password);
          };

          const isBetween = (length, min, max) => length < min || length > max ? false : true;
          const isRequired = value => value === '' ? false : true;

          const showError = (input, message) => {
              // get the form-field element
              const formField = input.parentElement;
              // add the error class
              formField.classList.remove('success');
              formField.classList.add('error');

              // show the error message
              const error = formField.querySelector('small');
              error.textContent = message;
          };
          const showSuccess = (input) => {
              // get the form-field element
              const formField = input.parentElement;

              // remove the error class
              formField.classList.remove('error');
              formField.classList.add('success');

              // hide the error message
              const error = formField.querySelector('small');
              error.textContent = '';
          }

          const checkUsername = () => {

            let valid = false;
            const min = 3,
                max = 25;
            const username = usernameEl.value.trim();

            if (!isRequired(username)) {
                showError(usernameEl, 'Username cannot be blank.');
            } else if (!isBetween(username.length, min, max)) {
                showError(usernameEl, `Username must be between ${min} and ${max} characters.`)
            } else {
                showSuccess(usernameEl);
                valid = true;
            }
            return valid;
          }
          const checkEmail = () => {
            let valid = false;
            const email = emailEl.value.trim();
            if (!isRequired(email)) {
                showError(emailEl, 'Email cannot be blank.');
            } else if (!isEmailValid(email)) {
                showError(emailEl, 'Email is not valid.')
            } else {
                showSuccess(emailEl);
                valid = true;
            }
            return valid;
          }
          const checkPassword = () => {

            let valid = false;

            const password = passwordEl.value.trim();

            if (!isRequired(password)) {
                showError(passwordEl, 'Password cannot be blank.');
            } else if (!isPasswordSecure(password)) {
                showError(passwordEl, 'Password must has at least 8 characters that include at least 1 lowercase character, 1 uppercase characters, 1 number, and 1 special character in (!@#$%^&*)');
            } else {
                showSuccess(passwordEl);
                valid = true;
            }

            return valid;
          };

          const checkConfirmPassword = () => {
            let valid = false;
            // check confirm password
            const confirmPassword = confirmPasswordEl.value.trim();
            const password = passwordEl.value.trim();

            if (!isRequired(confirmPassword)) {
                showError(confirmPasswordEl, 'Please enter the password again');
            } else if (password !== confirmPassword) {
                showError(confirmPasswordEl, 'Confirm password does not match');
            } else {
                showSuccess(confirmPasswordEl);
                valid = true;
            }

            return valid;
          };
          const debounce = (fn, delay = 500) => {
            let timeoutId;
            return (...args) => {
                // cancel the previous timer
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                // setup a new timer
                timeoutId = setTimeout(() => {
                    fn.apply(null, args)
                }, delay);
            };
          };

          form.addEventListener('input', debounce(function (e) {  
            switch (e.target.id) {
                case 'fname':
                    checkUsername();
                    break;
                case 'email':
                    checkEmail();
                    break;
                case 'password':
                    checkPassword();
                    break;
                case 'confirm-password':
                    checkConfirmPassword();
                    break;
            }
          }));
          //form.addEventListener("submit", validation);
          submitButton.addEventListener('click', function(event) {
            event.preventDefault();
            validateForm();
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');

            // validate forms
            let isUsernameValid = checkUsername(),
                isEmailValid = checkEmail(),
                isPasswordValid = checkPassword(),
                isConfirmPasswordValid = checkConfirmPassword();

            let isFormValid = isUsernameValid &&
                isEmailValid &&
                isPasswordValid &&
                isConfirmPasswordValid;
               
            // submit to the server if the form is valid
            if (isFormValid) {
              //  form.submit();
                RetriveVal();
            }
          });

          form.addEventListener("submit", RetriveVal);
          //form.addEventListener("submit", getAllInput);
          //form.addEventListener("submit", saveImageFile);
          function saveImageFile(event){
            var xhr = new XMLHttpRequest();
            xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                var progress = (event.loaded / event.total) * 100;
                document.getElementById("progressBar").style.width = progress + "%";
                document.getElementById("progressBar").innerHTML = Math.round(progress) + "%";
            }
            };
            // Include any additional headers required by your backend
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // File upload successful, update progress bar to 100%
                    document.getElementById("progressBar").style.width = "100%";
                    document.getElementById("progressBar").innerHTML = "100%";
                    alert("File upload successful!");
                    
                    // Display success message to the user
                  
                } else {
                    // File upload failed, display error message to the user
                    alert("File upload failed: " + xhr.statusText);
                }
                };
            xhr.open('POST', 'uploadFile.php');
            xhr.setRequestHeader("Content-Type", "multipart/form-data;boundary='file'");
            xhr.send(this.image.files[0]);
          }

          function validateForm() {
            const errors = [];

            for (let i = 0; i < form.elements.length; i++) {
              const input = form.elements[i];

              if (input.type === 'text' && !input.value.trim()) {
                errors.push(`${input.name} is required`);
              }
              //if (input.type === 'radio' && !input.value.trim()) {
                //errors.push(`${input.name} is required`);
              //}
              //if (input.type === 'file' && !input.value.trim()) {
                //errors.push(`${input.name} is required`);
              //}
            }

            if (errors.length > 0) {
              alert(errors.join('\n'));
            } else {
              form.submit();
            }
          }
          function getAllInput(event){
            document.querySelectorAll('input').forEach( input => {
                console.log(input.value);
            });
          }
          function RetriveVal(event){
            event.preventDefault();
         
            let data = {
                "fname": this.fname.value, 
                "lname": this.lname.value, 
                "suggestion": this.suggestion.value, 
                "cars": this['cars'].value, 
                "gender": this.gender.value,
                "agree": this.agree.checked,
                "services": []
            }
            let servicesList = document.querySelectorAll(".services");
                for (let service of servicesList){
                    if(service.checked == true){
                        data['services'].push(service.value);
                    }
                }
            console.log(data);

            let out = `
                <p>First Name: <span>${data.fname}</span></p><br>
                <p>Last Name: <span>${data.lname}</span></p><br>
                <p>suggestion: <span>${data.suggestion}</span></p><br>
                <p>Fav car: <span>${data.cars}</span></p><br>
                <p>Gender: <span>${data.gender}</span></p><br>
                <p>Agree: <span>${data.agree}</span></p><br>
                <p>Services: <span>${data.services}</span></p><br>
            `;
            let divTag = document.createElement("html");
            divTag.append(out);
            document.body.append(divTag);
           }
          var loadFile = function(event){
            let imageElement = document.createElement("img")
            let result_img = document.getElementById('profile');
            imageElement.src = URL.createObjectURL(event.target.files[0]);
            imageElement.setAttribute("height","55px");
            imageElement.setAttribute("alt","profile image");
            imageElement.setAttribute("width", "55px");
            result_img.appendChild(imageElement);
            const form = new FormData();
            form.append("file", event.target.files[0]);
            var xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                  // Handle the response here
                  console.log("done");
                }
              };

              xhttp.open("POST", "uploadFile.php", true);
              xhttp.setRequestHeader("Content-type", "multipart/form-data; boundary='file'");
             
              xhttp.send(form);
            } 
           
           
      </script>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  </body>
</html>